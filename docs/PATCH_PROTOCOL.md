# XGIT 补丁协议完整技术规范 v1.0

## 1. 协议概述
XGIT 补丁协议是一个基于文本的代码仓库操作指令集，提供文件操作、Git 操作和精确行级编辑能力。协议设计用于 AI 驱动的代码修改，支持事务性执行、自动预检和智能错误处理。

## 2. 系统架构

### 2.1 核心组件
- **patchd 守护进程**：文件监听和补丁执行引擎
- **解析器**：补丁文本解析和验证
- **执行器**：指令分发和事务管理
- **预检系统**：代码质量和格式检查
- **日志系统**：双重输出的操作审计

### 2.2 执行模型
```
补丁文件 → 稳定检测 → 解析验证 → 事务执行 → 预检处理 → Git 提交 → 自动推送
```

## 3. 补丁文件格式

### 3.1 整体结构
```
repo: <仓库名称>
commitmsg: <提交信息>
author: <作者信息>

=== <指令>: "<文件路径>" ===
参数1=值1
参数2=值2
多行参数<
 多行内容
>多行参数

正文内容
=== end ===

=== PATCH EOF ===
```

### 3.2 头部信息
- `repo`：目标仓库名称，映射到 `.repos` 配置文件
- `commitmsg`：Git 提交信息（默认：“chore: apply file ops patch”）
- `author`：提交作者信息（默认：“XGit Bot <bot@xgit.local>”）

**仓库解析优先级**：
1. 补丁内 Patch.Repo 字段
2. 补丁文件头部 `repo:` 行
3. `.repos` 文件的 default 配置

### 3.3 指令块语法
- **块头**：`=== <指令>: "<路径>" ===`（路径必须双引号包围）
- **参数区**：支持单行（K=V）和多行参数（K<…>K）
- **正文区**：参数区后到 `=== end ===` 的所有内容
- **块尾**：`=== end ===`
- **文件结束**：`=== PATCH EOF ===`（严格校验）

### 3.4 多行参数格式
```
参数名<
 内容行1（必须以空格开头）
 内容行2（必须以空格开头）
>参数名
```

## 4. 文件操作指令集

### 4.1 file.write
**功能**：创建或覆盖文件  
**处理**：自动创建目录（权限 755）、统一换行符为 LF、确保末尾换行、执行预检

### 4.2 file.append
**功能**：在文件末尾追加内容  
**实现**：读取现有内容，追加新内容，写回文件

### 4.3 file.prepend
**功能**：在文件开头插入内容  
**实现**：规范化新内容换行，与原内容合并

### 4.4 file.delete
**功能**：删除文件  
**实现**：直接删除文件，不执行预检

### 4.5 file.move
**功能**：移动/重命名文件  
**参数**：`to` - 目标路径（必需）

### 4.6 file.chmod
**功能**：修改文件权限  
**参数**：`mode` - 八进制权限值（必需）

### 4.7 file.eol
**功能**：统一文件换行符  
**参数**：
- `style`：`lf`（默认）| `crlf`
- `ensure_nl`：`true`（默认）| `false`

**实现**：读取文件内容，根据 `style` 转换换行符，可选确保末尾换行

### 4.8 file.image / file.binary
**功能**：创建二进制文件  
**正文**：Base64 编码的二进制数据  
**实现**：Base64 解码后写入文件

## 5. Git 操作指令集

### 5.1 git.diff
**功能**：应用 Git diff 补丁  
**正文**：标准 Git diff 格式内容  
**高级特性**：
- Markdown 围栏自动剥离（`diff` 或 `patch`）
- 多策略应用重试机制
- 结构化操作预处理（删除/重命名优先处理）
- 文件系统存在性预检
- 临时文件写入与校验
- 错误上下文提取和显示

**应用策略**：
1. 检测 diff 类型（新增/删除/重命名 vs 纯修改）
2. 新增/删除/重命名：跳过 3-way 合并
3. 纯修改：优先 3-way 合并，逐步降级
4. 统一使用宽松选项（--recount, --ignore-space-change 等）

### 5.2 git.revert
**功能**：重置仓库到指定提交（实际为 `git reset`）  
**参数**：
- `spec`：目标提交（必需）
- `strategy`：`hard`（默认）| `mixed` | `soft`  
**注意**：语义为 `git reset`，非 `git revert` 的反向提交

### 5.3 git.tag
**功能**：创建 Git 标签  
**参数**：
- `name`：标签名称（必需）
- `ref`：目标提交（默认 `HEAD`）
- `message`：标签消息（可选）
- `force`：强制覆盖（true/false）
- `push`：是否推送到远端（true/false）  
**实现**：支持轻量标签和附注标签

### 5.4 git.commit
**功能**：提交占位符  
**约束**：必须单独使用，不能与其他指令混合  
**实现**：仅作标记，实际提交由系统统一处理

## 6. 行级编辑指令集

### 6.1 核心参数
- `lineno`：作用域内相对行号（1-based）
- `keys`：关键字匹配（支持 `|` 和 `,` 分隔）
- `nthl`：keys 多匹配时的选择（line 指令用）
- `offset`：相对偏移（格式 `+N` 或 `-N`，仅无作用域时）
- `start-keys`：作用域起始关键字
- `end-keys`：作用域结束关键字（可选）
- `nthb`：作用域多匹配时的选择（block 指令用）

### 6.2 作用域解析
- 无 `start-keys`：全文作用域 `[1..EOF]`
- 有 `start-keys`：必须唯一命中（用 `nthb` 选择）
- `end-keys` 缺省：延伸到文件末尾
- `end-keys` 存在：在 `start` 后搜索，多处取第一个

### 6.3 智能匹配算法（优先级递减）
1. 单关键字唯一匹配：任一关键字独立唯一命中
2. 双关键字 AND 匹配：两两组合 AND 匹配寻找唯一行
3. 全关键字 AND 匹配：所有关键字同行出现

**匹配特性**：忽略大小写、忽略行首缩进、优先返回唯一性最强结果

### 6.4 指令详述
- `line.insert`：在目标行前插入
- `line.append`：在目标行后插入
- `line.replace`：替换目标行（支持多行）
- `line.delete`：删除目标行
- `block.delete`：删除整个作用域
- `block.replace`：替换整个作用域

## 7. 执行约束和规则

### 7.1 批次约束
- `lineno` 约束：每个补丁最多一个 `lineno` 指令，且必须首位
- `git.commit` 约束：必须单独成补丁，不可混合
- 违反约束将导致补丁拒绝执行

### 7.2 参数冲突规则
- 有作用域时禁用 `offset` 参数
- `lineno` 优先级高于 `keys`
- 参数冲突时立即报错终止

### 7.3 错误处理
- 定位失败时严格报错
- 不支持静默跳过机制
- 预检失败时终止整个补丁

## 8. 执行机制

### 8.1 文件监听
- 稳定检测：300ms 间隔检测文件大小稳定性
- EOF 校验：严格验证末尾 `=== PATCH EOF ===` 标记
- MD5 去重：计算文件前 8 位 hash 避免重复处理
- 监听文件：默认为当前目录的 `文本.txt`

### 8.2 事务执行
**事务选项**：
- `CleanAtStart`：开始前是否清理工作区
- `RollbackOnError`：失败时是否回滚

**执行流程**：
1. 记录当前 HEAD 提交
2. 可选清理工作区
3. 顺序执行所有指令
4. 失败时回滚到初始状态
5. 成功时继续提交推送

### 8.3 预检系统
**触发时机**：每个文件操作完成后立即执行  
**Go 文件预检**：
- 自动执行 `gofmt` 格式化
- 语法校验
- 保持原文件权限和修改时间
- 支持 CRLF 格式保持

**预检失败**：终止整个补丁执行并回滚

### 8.4 提交推送流程
1. 统一执行 `git add -A` 添加所有改动
2. 检查暂存区是否有改动（`git diff --cached --name-only -z`）
3. 无改动时跳过提交并记录
4. 创建提交（使用补丁中的作者和消息）
5. 自动推送到 `origin HEAD`

## 9. 日志系统

### 9.1 双重输出
- 控制台：实时显示执行状态
- 文件：`patch.log` 保存完整日志
- 格式：时间戳 + 消息（2006-01-02 15:04:05）

### 9.2 日志策略
- 每次执行时覆盖 `patch.log`
- 文件创建失败时仍可输出到控制台
- 详细记录每个操作的结果和影响行数

## 10. 守护进程

### 10.1 命令接口
- `xgit_patchd start`：启动守护进程
- `xgit_patchd stop`：停止守护进程
- `xgit_patchd status`：查看运行状态
- `xgit_patchd clearhash`：清除补丁哈希记录

### 10.2 进程管理
- PID 文件：`.xgit_patchd.pid`
- 进程存活检测
- 优雅停止机制

## 11. 配置系统

### 11.1 仓库映射（.repos 文件）
```
# 注释行
default = 默认仓库名
仓库名1 /绝对路径1
仓库名2 /绝对路径2
```

**格式规则**：
- 支持 `default = 仓库名` 设置默认仓库
- 支持 `仓库名 /绝对路径` 映射关系
- 支持 `#` 注释行
- 空行被忽略

## 12. 安全性和可靠性

### 12.1 原子性保证
- 所有文件写入使用原子操作
- 临时文件写入后回读校验
- 权限和修改时间保持

### 12.2 事务安全
- Git 事务保护
- 失败时自动回滚
- 操作前状态快照

### 12.3 数据完整性
- 文件内容 hash 校验
- 换行符规范化
- Base64 解码验证

## 13. 性能优化

### 13.1 文件处理
- 批量 Git 操作
- 智能差异检测
- 缓存和去重机制

### 13.2 内存管理
- 流式文件处理
- 临时文件及时清理
- 避免大文件全量加载

## 14. 错误处理和调试

### 14.1 错误分类
- 解析错误：补丁格式不正确
- 定位错误：行匹配失败
- 执行错误：文件操作失败
- Git 错误：版本控制操作失败

### 14.2 调试支持
- 详细的错误上下文
- 补丁行号定位
- 完整的操作日志
- 回滚状态记录

## 15. 扩展性设计

### 15.1 指令扩展
- 插件式指令注册
- 统一的参数解析
- 标准化的错误处理

### 15.2 预检扩展
- 基于文件扩展名的自动匹配
- 可配置的检查器注册
- 自定义格式化工具集成

## 16. 最佳实践

### 16.1 补丁设计
- 保持操作原子性
- 选择稳定的关键字
- 合理使用作用域
- 避免复杂的嵌套操作

### 16.2 错误预防
- 充分测试关键字匹配
- 验证文件存在性
- 使用相对路径
- 保持补丁简洁

### 16.3 性能考虑
- 避免过大的文件操作
- 合理批量处理
- 及时清理临时文件
- 监控内存使用

---

本规范基于完整代码实现，准确反映了 XGIT 系统的实际行为和能力。它不仅是补丁格式，更是一个完整的 AI 驱动代码修改框架。
