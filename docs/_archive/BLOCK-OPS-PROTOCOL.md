# XGit Block 指令集协议 (初稿)

本协议定义了 **Block 系列指令**，作为 Line
系列的扩展，支持通过区间范围进行批量行操作。

------------------------------------------------------------------------

## 1. 基本规则

1.  **指令格式**

        === block.<动作> "相对路径" ===
        <参数区>
        <正文区>
        === end ===

2.  **动作类型**

    -   `delete_block` 删除一个区间内的行
    -   `replace_block` 替换一个区间内的行

3.  **定位方式**

    -   通过 `start_keys` 或 `start_lineno` 定位区间起点
    -   通过 `end_keys` 或 `end_lineno` 定位区间终点

4.  **定位要求**

    -   `start` 必须唯一命中（除非设置了 `nth` 参数）
    -   `end` 默认取第一个命中（可通过规则细化）

5.  **参数区可用参数**

    -   `start_keys` : 起始行关键字（多关键字用多行/竖线/逗号分隔）
    -   `end_keys` : 结束行关键字（同上）
    -   `start_lineno` : 起始行号（与 keys 二选一）
    -   `end_lineno` : 结束行号（与 keys 二选一）
    -   `nth` : 当 start 或 keys 命中多处时，取第 n 个（默认必须唯一）
    -   `strict` : 是否严格匹配（保留，默认宽松模式）

------------------------------------------------------------------------

## 2. 区间逻辑

1.  **起点 (start)**
    -   必须唯一命中，除非设置了 `nth`
    -   支持宽松匹配（忽略大小写、忽略缩进）
2.  **终点 (end)**
    -   默认取第一个命中
    -   匹配顺序：宽松 → 强匹配第一个关键字 → 多个则取第一个
    -   若完全未命中则报错
3.  **范围约束**
    -   `end` 必须在 `start` 之后
    -   否则报错 `非法范围`
4.  **区间操作**
    -   delete_block : 删除 \[start..end\] 所有行
    -   replace_block: 用正文区替换 \[start..end\] 所有行

------------------------------------------------------------------------

## 3. 示例

### 3.1 删除函数块

``` patch
=== block.delete_block "src/main.go" ===
start_keys<
func hello(
>start_keys
end_keys<
}
>end_keys
=== end ===
```

### 3.2 替换配置片段

``` patch
=== block.replace_block "config.yaml" ===
start_keys<
database:
>start_keys
end_keys<
cache:
>end_keys

database:
  host: 127.0.0.1
  port: 5432
=== end ===
```

------------------------------------------------------------------------

## 4. 进阶规则

1.  **嵌套支持**
    -   一个 block 范围内可以继续 line 操作（未来可扩展）
2.  **组合定位**
    -   可结合 `start_keys + nth`、`end_lineno` 等方式灵活定位
3.  **边界处理**
    -   若范围越界 → 报错
    -   若空范围 → 报错
    -   不允许 allow_noop（避免静默失败）

------------------------------------------------------------------------

## 5. 适用范围

Block 系列主要用于： - 函数、类、配置段落的整体删除或替换 -
大块内容的迁移和改造 - Line 系列难以唯一定位的场景

------------------------------------------------------------------------

（完）
