# 📄 XGit Patch Parser 语法规范 v0.3

## 1. 顶层结构

补丁文件由 **顶层 KV**、**指令块（FileOp）**、**严格 EOF 标记**
三部分组成。

### 1.1 顶层 KV

-   出现在第一个 `=== ... ===` 指令块之前。

-   语法：

        key: value

-   支持字段（大小写不敏感）：\
    ✧ `commitmsg: ...`\
    ✧ `author: ...`\
    ✧ `repo: ...`

-   值做 `TrimSpace`。

### 1.2 严格 EOF

-   文件最后一个非空白行必须等于传入 EOF 标记（通常
    `=== PATCH EOF ===`）。

-   不满足时报错：

        严格 EOF 校验失败：期望 "=== PATCH EOF ==="，实际 "xxx"

------------------------------------------------------------------------

## 2. 指令块（FileOp）

一个补丁可包含多个 `FileOp` 块，每个块以 `=== ... ===` 开始，以
`=== end ===` 结束。

### 2.1 块头（Header）

-   语法：

        === <cmd>: "<path>" ===

-   `<cmd>`：小写字母，可包含点号与下划线（例：`line.insert_after`、`git.diff`）。\

-   `<path>`：必须双引号包裹，否则报错。

### 2.2 参数区（Args）

-   位于块头之后，正文之前。\
-   一旦遇到 **非 KV 行** → 进入正文区。

#### a) 单行 KV

    key=value

-   键名统一转小写。
-   值只去掉尾部换行，不裁剪前导空格。
-   同键重复 → 后者覆盖。

#### b) 多行块 `k<>k`

    key<
     <line1>
     <line2>
    >key

-   起始：`key<`\
-   结束：独占一行 `>key`\
-   内容规则：
    -   非空行必须以 1 个空格开头（解析时剥掉这 1 个空格）。\
    -   空行允许并保留。\
    -   找不到结束标记 → 报错。\
-   存储：整块拼接成一个字符串（带结尾换行）。

------------------------------------------------------------------------

## 3. 正文区（Body）

-   从参数区结束的第一行开始，到 `=== end ===` 之前。
-   所有内容**原样**保留（含空格、缩进、换行）。

------------------------------------------------------------------------

## 4. 报错点

1.  EOF 校验失败。\
2.  路径未用双引号。\
3.  多行块内非空行未加前导空格。\
4.  多行块缺少结束标记。

------------------------------------------------------------------------

## 5. 写补丁示例

✅ 单行 KV：

    === line.insert_after: "apps/web/index.html" ===
    keys=</header>
    icase=1

    <nav class="nav">
      <a href="/">返回官网</a>
    </nav>
    === end ===

✅ 多行值（`k<>k`）：

    === line.replace_line: "apps/web/index.html" ===
    keys<
     XGit
     Web App
    >keys
    icase=1
    ensure_nl=1

    <title>XGit</title>
    === end ===

❌ 错误示例（无前导空格）：

    keys<
    XGit
    Web App
    >keys

报错：

    多行块 keys< 的正文非空行必须以空格开头（行 N）

------------------------------------------------------------------------

## 6. 执行层约定（常见参数）

虽然 Parser 只负责结构化，但执行层通常会依赖这些参数： -
`lineno`：指定精确行号。\
- `keys`：关键字组，用于模糊匹配行号（单行 or 多行 k\<\>k）。\
- `icase=1`：忽略大小写。\
- `ensure_nl=1`：保证换行。

------------------------------------------------------------------------

## 7. 总结

✧ Parser **只负责结构化**（KV、正文、EOF 校验）。\
✧ 业务逻辑（如 `line.insert_after`、`git.diff` 等）在执行层解释 `Args`
与 `Body`。\
✧ 关键思想：**KV 进参数，正文进 Body，多行值用 k\<\>k 包裹，严格 EOF
收尾。**
