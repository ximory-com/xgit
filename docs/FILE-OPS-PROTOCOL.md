# XGit 文件级补丁协议 v1.0（11 条，定稿）

> 文件级操作是系统的“保底协议”。先把这层做**稳定不可变**，其它高级操作（Block/AST/模板）都可以在失败时回落到文件级。  
> 本文档描述 **11 条文件操作** 的**统一语义**、**格式**与**体检规则**，并约定日志与提交策略。

---

## 0. 统一约定（强制）

- **补丁块包裹**
  - 【头】`=== <指令名>: <参数...> ===`
  - 【体】该指令的内容（如文本、Base64、Diff 等）
  - 【尾】`=== end ===`
- **路径**：均为**仓库相对路径**；禁止绝对路径与 `..` 越界。
- **文本换行**：默认 **LF**，且保证**末行有换行**。
- **幂等性**：重复执行不得产生额外副作用（除非指令语义另有声明）。
- **索引/提交**：写入/变更类操作成功后自动 `git add -- <path>`；批次结束再统一提交与推送。
- **作者/提交说明（缺省）**：
  - `author: XGit Bot <bot@xgit.local>`
  - `commitmsg: chore: apply file ops patch`

---

## 1) file.write（覆盖写入）

**语义**：将【体】作为文件完整内容落盘；若文件不存在则创建父目录后新建。

- 【头】`file.write: <path>`
- 【体】文本内容（统一 LF；默认保证末尾换行）
- 【尾】`end`

**参数**
- `<path>`：目标文件相对路径

**体检**
- 路径安全检查（拒绝绝对路径/越界）
- 文本归一（CR→LF，末行换行）

**行为**
1. 创建父目录（如需）
2. 覆盖写入
3. `git add -- <path>`

**日志**
- 成功：`✅ 写入文件：<path>`
- 失败：`❌ 写入失败：<path> (原因)`

---

## 2) file.append（末尾追加）

**语义**：将【体】追加到文件末尾；无文件则新建后写入。

- 【头】`file.append: <path>`
- 【体】追加文本
- 【尾】`end`

**体检**：同 *file.write* 文本归一  
**行为**：读旧→拼接→写回→`git add`  
**日志**：`✅ 追加：<path> (+<len> B)`

---

## 3) file.prepend（开头插入）

**语义**：将【体】插到文件**开头**；无文件则新建。

- 【头】`file.prepend: <path>`
- 【体】插入文本
- 【尾】`end`

**体检/行为/日志**：同 *file.append*，但在首部拼接。

---

## 4) file.delete（删除文件）

**语义**：删除指定文件。

- 【头】`file.delete: <path>`
- 【体】（空）
- 【尾】`end`

**体检**
- 路径安全
- 若不存在：应**幂等**处理，记 info

**行为**
- 优先 `git rm -- <path>`；若未纳入索引则物理删除
- 无需 `git add`

**日志**
- 成功：`🗑️ 删除：<path>`
- 不存在：`ℹ️ 跳过删除（不存在）：<path>`

---

## 5) file.move（重命名/移动）

**语义**：将文件从 A 移到 B（支持重命名）。

- 【头】`file.move: <from> => <to>`
- 【体】（空）
- 【尾】`end`

**体检**
- 路径安全（from/to）
- `from` 存在性检查；`to` 父目录可创建

**行为**
- 优先 `git mv -f <from> <to>`；失败则物理移动+`git add` 新路径+`git rm` 旧路径（如在索引）
  
**日志**
- 成功：`🔁 改名：<from> => <to>`
- 不存在：`ℹ️ 跳过改名（不存在）：<from>`

---

## 6) file.chmod（修改权限）

**语义**：变更文件权限（如 `+x` / `-x` / `644`）。

- 【头】`file.chmod: <path> mode=<spec>`
- 【体】（空）
- 【尾】`end`

**体检**：`mode` 合法性（`+x/-x/0-7{3,4}`）  
**行为**：`chmod`；必要时 `git add --chmod=+x/-x <path>`（支持则用）  
**日志**：`🛠️ chmod：<path> => <spec>`

---

## 7) file.eol（换行策略）

**语义**：调整换行风格与末行换行策略。

- 【头】`file.eol: <path> style=<lf|crlf> ensure_nl=<0|1>`
- 【体】（空）
- 【尾】`end`

**体检**
- 文本/二进制判定（魔数优先）
- `style`/`ensure_nl` 合法

**行为**
- 读入→转换（LF 或 CRLF）→根据 ensure_nl 处理末行→写回→`git add`

**日志**：`🔧 eol：<path> style=<...> ensure_nl=<...>`

---

## 8) file.binary（二进制写入）

**语义**：以 **Base64** 作为【体】写入任意二进制文件。

- 【头】`file.binary: <path> encoding=base64`
- 【体】Base64
- 【尾】`end`

**体检**
- Base64 解码可行
- 二进制判定（必要时用魔数）

**行为**
- 解码→写入（不做文本归一）→`git add`

**日志**：`✅ 写入二进制：<path> (size=<N> B)`

---

## 9) file.image（图片写入）

**语义**：以 **Base64** 写入图片（png/jpg/webp/svg…），等价于 *file.binary*，但**附加**格式校验。

- 【头】`file.image: <path> encoding=base64`
- 【体】Base64
- 【尾】`end`

**体检**
- Base64 解码可行
- **魔数**或**MIME**判断图片格式与后缀一致（必要时可自动修正后缀）

**行为/日志**：同 *file.binary*，并记录格式：`🖼️ 写入图片：<path> (png, <N> B)`

---

## 10) file.replace（文本替换）

**语义**：在文本文件中执行替换操作（支持大小写敏感、正则、全局/单次）。

- 【头】`file.replace: <path> from=<pat> to=<rep> [regex=<0|1>] [icase=<0|1>] [global=<0|1>]`
- 【体】（空）
- 【尾】`end`

**参数**
- `from`：匹配表达式；当 `regex=1` 时为正则
- `to`：替换文本（支持常见转义）
- `regex`：是否正则（默认 0）
- `icase`：是否不区分大小写（默认 0）
- `global`：是否全局替换（默认 1；0 表示只替换第一个匹配）

**体检**
- 文本判定
- 正则编译可行（当 `regex=1`）
- 幂等性评估（如替换前后相同则记 info）

**行为**
- 读取→执行替换→写回→`git add`

**日志**
- `✏️ replace：<path> from=<...> to=<...> regex=<0|1> icase=<0|1> global=<0|1> (+/-<N> B)`

---

## 11) file.diff（应用 Git Diff）

**语义**：将【体】视为 **Unified Diff** 并应用到仓库（可跨多文件）。

- 【头】`file.diff: path=/ [mode=apply|reverse] [strip=1] [whitespace=nowarn] [threeway=<0|1>]`
- 【体】标准 unified diff 文本
- 【尾】`end`

**参数（建议缺省）**
- `mode`：`apply`（默认）或 `reverse`
- `strip`：路径层级剥离，默认 `1`
- `whitespace`：空白策略（默认 `nowarn`）
- `threeway`：三方合并尝试（默认 `0`）
- `path`：子目录起点（默认 `/` = 仓库根）

**体检**
- `git apply --check` 预检
- 失败需原子性中止并回滚

**行为**
- 预检通过 → `git apply` → `git add -A`（按需）

**日志**
- 成功：`✅ 已应用 diff（mode=..., strip=..., ...）`
- 失败：`❌ git apply 失败：...`

---

## 合规性与安全（全局）

1. **路径安全**：拒绝绝对路径、符号链接逃逸、`..` 越界；必要时规范化与白名单根目录绑定。
2. **文本/二进制识别**：魔数优先；扩展名仅参考。
3. **换行与编码**：默认 `LF` + 末行换行；二进制不做任何换行处理。
4. **幂等**：重复执行不产生重复内容（追加/替换需防抖）。
5. **事务性**：批次内任何一步失败 → 回滚到补丁开始前的 HEAD + 工作区清理。

---

## 提交与推送（标准流程）

- 若 `git diff --cached --name-only` 为空 → `ℹ️ 无改动需要提交。`
- 否则：
  - 使用补丁头部 `commitmsg`/`author`（或缺省）
  - `git commit` → `git push origin HEAD`
  - 日志：`✅ 已提交：<commitmsg>`；`🚀 推送完成` 或 `❌ 推送失败：<stderr>`

---

*文档版本：v1.0（文件级 11 条，定稿）；后续新增操作将独立文档与版本号，不影响本协议的兼容性。*
