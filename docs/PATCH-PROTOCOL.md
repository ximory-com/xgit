# XGit 补丁协议技术规范 v1.0

## 1. 协议概述
XGit 补丁协议是一套基于文本的代码仓库操作指令规范，旨在为 AI 驱动的代码修改提供标准化交互接口，支持文件操作、行级精准编辑、块级操作及 Git 版本控制。协议核心特性包括事务性执行、严格格式校验、智能错误处理及扩展式预检能力。

## 2. 补丁文件格式规范
### 2.1 整体结构
```
repo: <仓库名称>
commitmsg: <提交信息>
author: <作者信息>

=== <指令>: "<文件路径>" ===
参数1=值1
参数2=值2
多行参数<
 多行内容(单个空格缩进)
>多行参数

正文内容
=== end ===

=== PATCH EOF ===
```
[正文内容]
=== end ===
=== PATCH EOF ===
### 2.2 头部字段
| 字段名 | 含义 | 默认值 | 优先级 |
|--------|------|--------|--------|
| `repo` | 目标仓库标识，映射至 `.repos` 配置 | - | 1. Patch.Repo → 2. 头部 `repo:` → 3. `.repos` default |
| `commitmsg` | Git 提交说明 | "chore: apply file ops patch" | 补丁头部定义优先 |
| `author` | 提交作者信息（格式："Name <email>"） | "XGit Bot <bot@xgit.local>" | 补丁头部定义优先 |

### 2.3 指令块语法
- 块头：以 `=== <指令>: "<路径>" ===` 开头，路径必须用双引号包裹，指令区分大小写。
- 参数区：支持单行参数（`K=V`）与多行参数（`K<...>K`），多行内容需以空格开头，参数键统一转为小写。
- 正文区：参数区结束后至 `=== end ===` 之间的内容，用于存储文件内容、diff 文本等核心数据。
- 块尾：以 `=== end ===` 标识单个指令结束，整个补丁以 `=== PATCH EOF ===` 收尾（严格校验）。

## 3. 核心指令集
### 3.1 文件操作指令（`file.*`）
| 指令 | 功能 | 必需参数 | 特性 |
|------|------|----------|------|
| `file.write` | 创建或覆盖文件 | - | 自动创建目录（755）、统一 LF 换行、确保末尾换行、执行预检 |
| `file.append` | 向文件末尾追加内容 | - | 读取原有内容后合并写入，保持换行规范 |
| `file.prepend` | 向文件开头插入内容 | - | 不存在时等价于 `file.write`，合并内容后覆盖写入 |
| `file.delete` | 删除文件/目录 | - | 递归删除目标，自动清理空父目录 |
| `file.move` | 移动/重命名文件 | `to`（目标路径） | 支持跨目录操作，自动创建目标目录 |
| `file.chmod` | 修改文件权限 | `mode`（八进制权限值） | 直接变更文件权限，如 644、755 |
| `file.eol` | 统一换行符格式 | `style`（lf/crlf，默认 lf）、`ensure_nl`（是否确保末尾换行，默认 true） | 按参数转换换行符，支持格式保持 |
| `file.binary` | 写入二进制文件 | - | 正文为 Base64 编码数据，解码后写入文件 |
| `file.image` | 写入图片文件 | - | 语义同 `file.binary`，后续可扩展图片校验 |

### 3.2 行级编辑指令（`line.*`）
#### 3.2.1 通用参数
| 参数 | 含义 | 适用指令 |
|------|------|----------|
| `lineno` | 作用域内相对行号（1-based） | 所有 line.* 指令 |
| `keys` | 关键字匹配（支持 `|`/`,` 分隔） | 所有 line.* 指令 |
| `nthl` | 多关键字匹配时的选择序号（1-based，默认取首个） | line.* 指令 |
| `offset` | 行偏移（格式 `+N` 或 `-N`，N 为正整数） | 无作用域时的 line.* 指令 |
| `start-keys` | 作用域起始关键字（支持 `|`/`,`/换行分隔） | 行级指令 |
| `end-keys` | 作用域结束关键字（支持 `|`/`,`/换行分隔，可选） | 行级指令 |

#### 3.2.2 关键字匹配核心规则（`keys`/`start-keys`/`end-keys`）
##### 3.2.2.1 关键字解析规则
1.  **分隔符处理**：自动识别并拆分多种分隔符，统一转为“备选关键字集”：
    - 竖线（`|`）：表示“或”关系，如 `key1|key2` 拆分为 `[key1, key2]`
    - 逗号（`,`）：表示“或”关系，如 `key1,key2` 拆分为 `[key1, key2]`
    - 换行：表示“或”关系，多行关键字自动合并为备选集。
2.  **预处理逻辑**：
    - 自动剔除空字符串：过滤拆分后全空白的关键字。
    - 大小写忽略：匹配时不区分大小写。
    - 缩进忽略：匹配时忽略行首空格/制表符。

##### 3.2.2.2 `keys` 匹配规则（行级定位）
`keys` 用于 line.* 指令的目标行定位，采用“宽松唯一命中”策略，优先级从高到低如下：
1.  **单关键字唯一匹配**：遍历备选关键字集，若任一关键字单独命中且仅命中 1 行，则取该行为目标行。
2.  **双关键字 AND 匹配**：若单关键字无唯一命中，取备选集中所有双关键字组合，执行“AND 匹配”（同一行包含两个关键字），若某组合唯一命中，则取该行为目标行。
3.  **全关键字 AND 匹配**：若双关键字组合无唯一命中，检查是否所有备选关键字均存在于同一行，若唯一命中则取该行。
4.  **多匹配处理**：
    - 若匹配结果为多行，且指定 `nthl` 参数，则取第 `nthl` 行（1-based）。
    - 若未指定 `nthl`，则报错并返回所有匹配行号。
5.  **匹配范围约束**：仅在当前作用域内执行匹配（无作用域时为全文）。

##### 3.2.2.3 作用域定位规则（`start-keys`/`end-keys`）
1.  **`start-keys` 定位规则**：采用与 `keys` 相同的“宽松唯一命中”策略，必须返回唯一行；多匹配需指定选择序号，否则报错；起始行必须在文件有效范围内。
2.  **`end-keys` 定位规则**：仅在 `start-keys` 定位的起始行之后搜索；采用“宽松首次命中”策略；未指定时默认文件最后一行；起始行后无匹配行或结束行 < 起始行时报错。
3.  **作用域生效规则**：
    - 有 `start-keys`，无 `end-keys`：`[start, 总行数]`
    - 有 `start-keys`，有 `end-keys`：`[start, end]`（end ≥ start）
    - 无 `start-keys`，无 `end-keys`：`[1, 总行数]`（全文）

#### 3.2.3 指令详情
| 指令 | 功能 | 核心逻辑 |
|------|------|----------|
| `line.insert` | 在目标行前插入内容 | 按 `keys`/`lineno` 定位目标行，在其前插入正文内容（支持多行） |
| `line.append` | 在目标行后插入内容 | 定位目标行后追加正文，支持多行插入 |
| `line.replace` | 替换目标行内容 | 用正文替换定位到的单行，支持多行替换 |
| `line.delete` | 删除目标行 | 定位目标行后移除，更新文件内容并确保末尾换行 |

### 3.3 块级操作指令（`block.*`）
#### 3.3.1 通用参数
| 参数 | 含义 | 适用指令 |
|------|------|----------|
| `start-keys` | 作用域起始关键字（支持 `|`/`,`/换行分隔） | 所有 block.* 指令 |
| `end-keys` | 作用域结束关键字（支持 `|`/`,`/换行分隔，可选） | 所有 block.* 指令 |
| `nthb` | 多作用域匹配时的选择序号（1-based，默认取首个） | block.* 指令 |

#### 3.3.2 关键字匹配核心规则（`start-keys`/`end-keys`）
##### 3.3.2.1 关键字解析规则
同 3.2.2.1 行级编辑指令的关键字解析规则。

##### 3.3.2.2 作用域定位规则
1.  **`start-keys` 定位规则**：采用与 `keys` 相同的“宽松唯一命中”策略，但必须返回唯一行（或通过 `nthb` 指定）；多匹配未指定 `nthb` 时直接报错；起始行必须在文件有效范围内。
2.  **`end-keys` 定位规则**：仅在 `start-keys` 定位的起始行之后搜索；采用“宽松首次命中”策略；未指定时默认文件最后一行；起始行后无匹配行或结束行 < 起始行时报错。
3.  **作用域生效规则**：
    - 有 `start-keys`，无 `end-keys`：`[start, 总行数]`
    - 有 `start-keys`，有 `end-keys`：`[start, end]`（end ≥ start）
    - 无 `start-keys`，无 `end-keys`：`[1, 总行数]`（全文）

#### 3.3.3 指令详情
| 指令 | 功能 | 核心逻辑 |
|------|------|----------|
| `block.delete` | 删除指定作用域内容 | 解析 `start-keys`/`end-keys` 确定范围，批量删除范围内所有行 |
| `block.replace` | 替换指定作用域内容 | 用正文替换作用域内所有内容，保持文件格式规范 |

### 3.4 Git 操作指令（`git.*`）
| 指令 | 功能 | 必需参数 | 特性 |
|------|------|----------|------|
| `git.diff` | 应用 Git diff 补丁 | - | 正文为标准 diff 格式，支持围栏自动剥离、多策略重试、文件存在性预检 |
| `git.reset` | 重置仓库至指定提交 | `ref`（目标提交）、`mode`（hard/mixed/soft，默认 hard） | 对应 Git 原生 `git reset` 功能 |
| `git.revert` | 撤销指定提交更改 | `ref`（目标提交）、`no_commit`（是否不自动提交，默认 false） | 对应 Git 原生 `git revert` 功能，支持批量撤销 |
| `git.tag` | 创建/更新 Git 标签 | `name`（标签名） | 支持轻量/附注标签，可配置强制覆盖与远端推送 |
| `git.commit` | 提交占位符 | - | 必须单独作为补丁唯一指令，实际提交由系统统一处理 |

## 4. 示例
```
repo: xgit
commitmsg: Fix login timeout bug
author: Zhang San zhangsan@example.com
=== file.write: "src/utils/auth.py" ===
func check_token(token string) bool {
timeout := 60  // Extend timeout to 60s
token_expire_check := true
// Token validation logic
return true
}
=== end ===
=== line.replace: "docs/login_guide.md" ===
keys=Note: Login timeout is 30 seconds.
Note: Login timeout is 60 seconds.
=== end ===
=== PATCH EOF ===
```