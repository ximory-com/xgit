# 📘 XGit 指令集协议 vNext

## ✧ 1. 通用规则

1.  **唯一命中优先**
    -   所有定位（line / block start）必须唯一命中。\
    -   如果多处命中：
        -   可用 `nth=n` 指定第 n 个；\
        -   否则报错（End 除外，见下）。
2.  **关键字匹配**
    -   默认忽略大小写、忽略缩进。\
    -   `keys` 内多个关键字 → **AND 逻辑**（必须都包含）。
3.  **offset 偏移**
    -   可选参数 `offset`，默认 = 0。\
    -   在锚点行的基础上做 ±N 行偏移后再执行操作。\
    -   仅适用于 **Line 指令**，Block 指令不支持。
4.  **严格性**
    -   不允许"无效操作"：
        -   删除不存在的行/块 → 报错；\
        -   替换无命中 → 报错；\
        -   插入找不到锚点 → 报错。
5.  **幂等性**
    -   `insert` / `append`
        如果插入内容已经存在于目标位置，不会重复插入。\
    -   `replace` 如果新旧内容一致，不会修改。
6.  **日志输出**
    -   每个操作必须输出：指令名、目标文件、命中行号（范围）、操作详情。\
    -   错误情况必须明确报错原因。

------------------------------------------------------------------------

## ✧ 2. Line 指令集

### 2.1 line.insert

在锚点行 **之前** 插入正文（支持多行）。

    === line.insert "src/app.js" ===
    keys<
     <body>
    >keys
    offset=0
        <header>Inserted Header</header>
    === end ===

### 2.2 line.append

在锚点行 **之后** 插入正文（支持多行）。

    === line.append "src/app.js" ===
    keys<
     </body>
    >keys
        <footer>Copyright</footer>
    === end ===

### 2.3 line.replace

用正文替换锚点行（允许多行覆盖）。

    === line.replace "src/config.json" ===
    keys<
     version
    >keys
        "version": "2.0.0",
    === end ===

### 2.4 line.delete

删除锚点行。

    === line.delete "src/app.js" ===
    keys<
     console.log
    >keys
    === end ===

------------------------------------------------------------------------

## ✧ 3. Block 指令集

### 3.1 block.delete

删除整个区间（包含 start/end）。

    === block.delete "src/app.js" ===
    start_keys<
     function main
    >start_keys
    end_keys<
     }
    >end_keys
    === end ===

### 3.2 block.replace

替换整个区间，用正文覆盖。

    === block.replace "src/app.js" ===
    start_keys<
     function main
    >start_keys
    end_keys<
     }
    >end_keys
    function main() {
        console.log("new block");
    }
    === end ===

------------------------------------------------------------------------

## ✧ 4. 行定位规则

-   **lineno**: 直接指定行号。\
-   **keys**: 关键字组，支持多行或 `|` 分隔。\
-   **nth**: 多处命中时取第 n 个。\
-   **offset**: 相对锚点 ±N 行偏移（仅 line 指令）。

------------------------------------------------------------------------

## ✧ 5. Block 定位规则

### 5.1 start_keys 命中规则

1.  **必须唯一命中**
    -   默认要求唯一命中，否则报错。\
    -   如果多处命中，可用 `nth=n` 指定取第 n 个。\
2.  **匹配方式**
    -   默认宽松匹配（忽略缩进、大小写），关键字组为 AND 逻辑。\
    -   任何一个关键字无法命中 → 报错。

### 5.2 end_keys 命中规则

1.  **范围限定**
    -   只在 **start 行之后** 开始搜索。\
2.  **命中逻辑**
    -   唯一命中 → 成功。\
    -   多处命中 →
        -   先尝试用第一个关键字做强匹配（整行包含关系，不忽略缩进）；\
        -   如果唯一命中则成功；\
        -   如果仍然多处，则默认取第一个。\
    -   未命中 → 报错。\
3.  **常见用法**
    -   用大括号 `{` / `}` 配合 function 定位函数体；\
    -   用 XML/HTML 标签配合缩进，确保能取到唯一闭合点。

------------------------------------------------------------------------

## ✧ 6. 推荐实践

-   **行操作优先**：常用场景尽量用 `line.*`，逻辑简单稳定。\
-   **块操作保底**：只有涉及函数/配置段落整体替换时才用 `block.*`。\
-   **nth 明确取第几个**：遇到重复行，必须加 `nth` 避免歧义。\
-   **日志必查**：每次补丁应用后，检查日志确认命中行是否符合预期。
